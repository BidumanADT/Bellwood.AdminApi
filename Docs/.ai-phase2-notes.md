# AI Working Notes - Phase 2 Implementation

**Purpose**: Internal roadmap for AI to track Phase 2 implementation  
**Status**: Planning  
**Not for human consumption** - Just AI's checklist and notes

---

## Implementation Order

### 1. Data Layer (First)
- [ ] Create OAuthClientCredentials entity
- [ ] Add to data models
- [ ] Create repository interface
- [ ] Implement file-based repository (consistent with current storage)
- [ ] Add encryption helpers (Data Protection API)

### 2. Authorization Policies (Second)
- [ ] Add AdminOnly policy to Program.cs
- [ ] Add StaffOnly policy to Program.cs
- [ ] Add BookerOnly policy (optional)

### 3. Helper Methods (Third)
- [ ] Add IsDispatcher() to UserAuthorizationHelper
- [ ] Add IsAdmin() to UserAuthorizationHelper (already exists, verify)
- [ ] Add field masking helper

### 4. Billing DTOs (Fourth)
- [ ] Create BookingDetailDto with billing fields
- [ ] Create QuoteDetailDto with billing fields
- [ ] Ensure nullable fields for masking

### 5. Apply Policies to Endpoints (Fifth)
- [ ] Map all current endpoints
- [ ] Identify operational vs admin
- [ ] Apply StaffOnly to operational
- [ ] Apply AdminOnly to admin/billing

### 6. Field Masking Implementation (Sixth)
- [ ] Update booking detail endpoint
- [ ] Update quote detail endpoint
- [ ] Add conditional masking logic

### 7. OAuth Credential Management (Seventh)
- [ ] Create GET /api/admin/oauth endpoint
- [ ] Create PUT /api/admin/oauth endpoint
- [ ] Implement encryption/decryption
- [ ] Add caching layer
- [ ] Update LA integration to use DB credentials

### 8. Testing (Eighth)
- [ ] Create Test-Phase2-Dispatcher.ps1
- [ ] Test diana (dispatcher) authentication
- [ ] Test StaffOnly access
- [ ] Test AdminOnly denial
- [ ] Test field masking
- [ ] Test OAuth credential management

### 9. Documentation (Ninth)
- [ ] Update 11-User-Access-Control.md with actual implementation
- [ ] Mark Phase 2 as complete
- [ ] Update STATUS-REPORT.md

---

## Key Design Decisions to Validate

1. **Storage**: Use file-based JSON for OAuth credentials (consistent with current system)
   - Alternative: Could use in-memory only, but want persistence
   - Decision: File-based with encryption

2. **Encryption**: Use ASP.NET Core Data Protection API
   - Simpler than custom encryption
   - Built-in key rotation support
   - Suitable for development & production

3. **Caching**: In-memory singleton with IMemoryCache
   - Invalidate on credential update
   - Lazy load on first access

4. **DTOs**: Create new DTOs rather than modifying existing entities
   - Cleaner separation
   - Easier to mask fields
   - Better API contract

5. **Endpoint Organization**: Keep minimal API style
   - Group OAuth endpoints together
   - Use AdminOnly policy
   - Follow existing patterns

---

## Questions for User (Before Starting)

1. OAuth credentials storage location
2. Encryption key management
3. Current LimoAnywhere integration points
4. Billing fields to mask

---

## Implementation Artifacts

Files to create:
- Models/OAuthClientCredentials.cs
- Models/BillingDtos.cs
- Services/IOAuthCredentialRepository.cs
- Services/FileOAuthCredentialRepository.cs
- Services/OAuthCredentialService.cs (caching + encryption)

Files to modify:
- Program.cs (policies + endpoints)
- Services/UserAuthorizationHelper.cs (new methods)

---

## Completion Criteria

- [ ] All policies defined
- [ ] All endpoints have correct policies
- [ ] Dispatcher gets masked data
- [ ] Admin gets full data
- [ ] OAuth CRUD works
- [ ] OAuth credentials encrypted
- [ ] All tests passing
- [ ] Documentation updated
